# task

Used by the `cirrus` module to create cirrus tasks. Aside from using the
[Inputs](#inputs) section below as a reference for creating task YAML definitions,
interactions with this module should happen through the interface provided by
the `cirrus` module rather than using this module directly.

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.6.6 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | ~> 5.22 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | ~> 5.22 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_resource_prefix"></a> [resource\_prefix](#input\_resource\_prefix) | String prefix to be used in every named resource. | `string` | n/a | yes |
| <a name="input_vpc_subnet_ids"></a> [vpc\_subnet\_ids](#input\_vpc\_subnet\_ids) | List of subnet ids in the target VPC that cirrus task resources should be connected to. | `list(string)` | n/a | yes |
| <a name="input_vpc_security_group_ids"></a> [vpc\_security\_group\_ids](#input\_vpc\_security\_group\_ids) | List of security groups in the target VPC that cirrus task resources should use. | `list(string)` | n/a | yes |
| <a name="input_task_config"></a> [task\_config](#input\_task\_config) | Defines a single cirrus task. This task may be used by zero..many cirrus workflows (see `workflow` module). A task may have a lambda config, a batch config, or both.<br/><br/>`name`: Identifier for the cirrus task. Must be unique across all cirrus tasks. Valid characters are: `[A-Za-z0-9-]`.<br/><br/>`common_role_statements`: List of IAM statements to be applied to both the lambda function and the batch job IAM role. This object is used to create a `aws_iam_policy_document` terraform data source. Refer to that data source's [documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) for more information on the available arguments.<br/><br/>`lambda`: Used to create a task lambda function and its ancillary resources. Many of the available arguments map directly to the ones in the `aws_lambda_function` terraform resource. Refer to that resource's [documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function) for more information on the available arguments. Object contents:<br/>- `lambda.resolve_ecr_tag_to_digest`: Whether the image in `lambda.ecr_image_uri` should have its tag resolved to the latest digest. Useful for tasks that use mutable image tags. Only valid for ECR-based images. Image URI must be in `<ECR repository URI>@<tag>` format.<br/>- `lambda.vpc_enabled`: Whether the lambda should be deployed within the specified `var.vpc_subnet_ids` and use `var.vpc_security_group_ids`.<br/>- `lambda.role_statements`: List of IAM statements to be applied to the lambda execution role in addition to any specified in `var.task_config.common_role_statements`.<br/>- `lambda.alarms`: List of CloudWatch alarm configs that will be created to monitor the cirrus task lambda function.<br/>- ... other common [aws\_lambda\_function](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function#argument-reference) arguments ...<br/><br/>`batch`: Used to create a task batch job definition and its ancillary resources. Many of the available arguments map directly to the ones in the `aws_batch_job_definition` resource. Refer to that resource's [documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/batch_job_definition) for more information on the available arguments. Object contents:<br/>- `batch.task_batch_compute_name`: The name of a batch compute resource set created by the `task_batch_compute` module. This determines where invocations of this task's job definition will run.<br/>- `batch.container_properties`: JSON string used for registering the batch job. See the [RegisterJobDefinition AWS documentation](https://docs.aws.amazon.com/batch/latest/APIReference/API_RegisterJobDefinition.html) for valid key/values.<br/>- `batch.resolve_ecr_tag_to_digest`: Whether the image in `batch.container_properties.image` should have its tag resolved to the latest digest. Useful for tasks that use mutable image tags. Only valid for ECR-based images. Image URI must be in `<ECR repository URI>@<tag>` format.<br/>- `batch.retry_strategy`: Configures how failed batch jobs should be retried, if at all.<br/>- `batch.parameters`: Parameter substitution placeholders that can be overridden at batch job submission time. For typical cirrus batch tasks, the values `url` and `url_out` should be set to any non-empty string value here.<br/>- `batch.role_statements`: List of IAM statements to be applied to the batch job execution role in addition to any specified in `var.task_config.common_role_statements`.<br/>- `batch.scheduling priority`: Determines the priority of these batch jobs in a job queue with a fair share scheduling policy. If the associated compute environment's queue does not use a fair share policy, this should not be set.<br/>- `batch.timeout_seconds`: Maximum duration these batch jobs should be allowed to run before being terminated by AWS.<br/>#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ | <pre>object({<br/>    name = string<br/><br/>    common_role_statements = optional(list(object({<br/>      sid           = string<br/>      effect        = string<br/>      actions       = list(string)<br/>      resources     = list(string)<br/>      not_actions   = optional(list(string))<br/>      not_resources = optional(list(string))<br/>      condition = optional(object({<br/>        test     = string<br/>        variable = string<br/>        values   = list(string)<br/>      }))<br/>      principals = optional(object({<br/>        type        = string<br/>        identifiers = list(string)<br/>      }))<br/>      not_principals = optional(object({<br/>        type        = string<br/>        identifiers = list(string)<br/>      }))<br/>    })))<br/><br/>    lambda = optional(object({<br/>      description               = optional(string)<br/>      ecr_image_uri             = optional(string)<br/>      resolve_ecr_tag_to_digest = optional(bool)<br/>      filename                  = optional(string)<br/>      image_config = optional(object({<br/>        command           = optional(list(string))<br/>        entry_point       = optional(list(string))<br/>        working_directory = optional(string)<br/>      }))<br/>      s3_bucket            = optional(string)<br/>      s3_key               = optional(string)<br/>      handler              = optional(string)<br/>      runtime              = optional(string)<br/>      timeout_seconds      = optional(number)<br/>      memory_mb            = optional(number)<br/>      ephemeral_storage_mb = optional(number)<br/>      publish              = optional(bool)<br/>      architectures        = optional(list(string))<br/>      env_vars             = optional(map(string))<br/>      vpc_enabled          = optional(bool)<br/>      role_statements = optional(list(object({<br/>        sid           = string<br/>        effect        = string<br/>        actions       = list(string)<br/>        resources     = list(string)<br/>        not_actions   = optional(list(string))<br/>        not_resources = optional(list(string))<br/>        condition = optional(object({<br/>          test     = string<br/>          variable = string<br/>          values   = list(string)<br/>        }))<br/>        principals = optional(object({<br/>          type        = string<br/>          identifiers = list(string)<br/>        }))<br/>        not_principals = optional(object({<br/>          type        = string<br/>          identifiers = list(string)<br/>        }))<br/>      })))<br/>      alarms = optional(list(object({<br/>        critical            = bool<br/>        statistic           = string<br/>        metric_name         = string<br/>        comparison_operator = string<br/>        threshold           = number<br/>        period              = optional(number, 60)<br/>        evaluation_periods  = optional(number, 5)<br/>      })))<br/>    }))<br/><br/>    batch = optional(object({<br/>      task_batch_compute_name   = string<br/>      container_properties      = string<br/>      resolve_ecr_tag_to_digest = optional(bool)<br/>      retry_strategy = optional(object({<br/>        attempts = number<br/>        evaluate_on_exit = optional(list(object({<br/>          action           = string<br/>          on_exit_code     = optional(string)<br/>          on_reason        = optional(string)<br/>          on_status_reason = optional(string)<br/>        })))<br/>      }))<br/>      parameters = optional(map(string))<br/>      role_statements = optional(list(object({<br/>        sid           = string<br/>        effect        = string<br/>        actions       = list(string)<br/>        resources     = list(string)<br/>        not_actions   = optional(list(string))<br/>        not_resources = optional(list(string))<br/>        condition = optional(object({<br/>          test     = string<br/>          variable = string<br/>          values   = list(string)<br/>        }))<br/>        principals = optional(object({<br/>          type        = string<br/>          identifiers = list(string)<br/>        }))<br/>        not_principals = optional(object({<br/>          type        = string<br/>          identifiers = list(string)<br/>        }))<br/>      })))<br/>      scheduling_priority = optional(number)<br/>      timeout_seconds     = optional(number)<br/>    }))<br/>    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br/>  })</pre> | n/a | yes |
| <a name="input_cirrus_task_batch_compute"></a> [cirrus\_task\_batch\_compute](#input\_cirrus\_task\_batch\_compute) | (Optional) A map of `task_batch_compute` module outputs keyed by their resource set's `name`. These are used to link any batch cirrus tasks with a target compute resource set. | <pre>map(object({<br/>    batch = object({<br/>      compute_environment_arn        = string<br/>      compute_environment_is_fargate = bool<br/>      ecs_task_execution_role_arn    = string<br/>      job_queue_arn                  = string<br/>      job_queue_is_fair_share        = string<br/>    })<br/>  }))</pre> | `null` | no |
| <a name="input_cirrus_payload_bucket"></a> [cirrus\_payload\_bucket](#input\_cirrus\_payload\_bucket) | (Optional) S3 bucket for storing cirrus payloads. Required if any cirrus batch tasks are defined as their job's IAM role will automatically be granted read/write permissions on this bucket to facilitate the necessary `pre-batch -> batch job -> post-batch` flow used by state machines. | `string` | `null` | no |
| <a name="input_warning_sns_topic_arn"></a> [warning\_sns\_topic\_arn](#input\_warning\_sns\_topic\_arn) | (Optional) SNS topic to be used by all cirrus lambda task `warning` alarms. This is primarily used by the `pre-batch` and `post-batch` lambda tasks that are managed by the parent `cirrus` module.<br/><br/>If any non-critical cirrus lambda task alarms are configured via `var.task_config.lambda.alarms`, they will use this SNS topic for their alarm action. | `string` | `null` | no |
| <a name="input_critical_sns_topic_arn"></a> [critical\_sns\_topic\_arn](#input\_critical\_sns\_topic\_arn) | (Optional) SNS topic to be used by all cirrus lambda task `critical` alarms. This is primarily used by the `pre-batch` and `post-batch` lambda tasks that are managed by the parent `cirrus` module.<br/><br/>If any critical cirrus lambda task alarms are configured via `var.task_config.lambda.alarms`, they will use this SNS topic for their alarm action. | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_lambda"></a> [lambda](#output\_lambda) | Output ARNs for the resulting cirrus task lambda resources. |
| <a name="output_batch"></a> [batch](#output\_batch) | Output ARNs for the resulting cirrus task batch resources. |
<!-- END_TF_DOCS -->
